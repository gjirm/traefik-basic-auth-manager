<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <title>Traefik basic authentication manager</title>
</head>
<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <div class="container mt-5" style="max-width: 500px;">
        <div class="mb-3">
            <h3>Access for <a href="{{ .title }}">{{ .title }}</a></h3>
            <p class="lead">
                Credentials for user {{.user}}
            </p>
        </div>
        <div class="mb-3">
            <div class="list-group">
                <a href="#" class="list-group-item list-group-item-action list-group-item-primary disabled" id="activate" onclick="activateSession()">Activate credentials</a>
                <a href="#Modal" class="list-group-item list-group-item-action list-group-item-primary" id="generate" onclick="openModal()">Generate new credentials</a>
                
                <!-- <a href="#" class="list-group-item list-group-item-action list-group-item-primary" id="generate" onclick="generateCredentials()">Generate new credentials</a> -->
            </div>
        </div>
        <div class="mb-3">
            <div class="alert alert-info" role="alert" id="status" style="display:none;"></div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="Modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
        <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Generate new credentials</h5>
            <button type="button" class="close" onclick="closeModal()" aria-label="Close">
            <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body">
            Your old credentials will be overwritten. Do you really want to generate new credentials?
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">Close</button>
            <button type="button" class="btn btn-primary" onclick="generateCredentials()">Generate</button>
        </div>
        </div>
    </div>
    </div>

</body>
<script>

    function openModal() {
        //document.getElementById("backdrop").style.display = "block"
        document.getElementById("Modal").style.display = "block"
        document.getElementById("Modal").className += "show"
    }
    function closeModal() {
        //document.getElementById("backdrop").style.display = "none"
        document.getElementById("Modal").style.display = "none"
        document.getElementById("Modal").className += document.getElementById("Modal").className.replace("show", "")
    }
    // Get the modal
    var modal = document.getElementById('Modal');
    
    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal()
      }
    }

    document.addEventListener('readystatechange', event => { 
        if (event.target.readyState === "complete") {
           checkUserStatus();
        }
    });

    function checkUserStatus() {
        document.getElementById("status").style.display = "block";
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                console.log('response', this.responseText);
                if (this.responseText == "User not exists") {
                    document.getElementById("status").className = "alert alert-warning"
                    document.getElementById("status").innerHTML = "You have no credentials. Please generate new.";
                } else {
                    var myArr = JSON.parse(this.responseText);
                    document.getElementById("activate").classList.remove("disabled")
                    displayOutput(myArr);
                }
            }
        };
        xmlhttp.open("GET", "/status", true);
        xmlhttp.send();

        function displayOutput(arr) {
            out = "Validity<br>Session: " + arr.session + "<br>Credential: " + arr.credential + "<br>";
            document.getElementById("status").innerHTML = out;
        }
    }

    function generateCredentials() {
        document.getElementById("status").style.display = "block";
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                console.log('response', this.responseText);
                var myArr = JSON.parse(this.responseText);
                displayCredentials(myArr);
            }
        };
        xmlhttp.open("GET", "/generate", true);
        xmlhttp.send();

        closeModal();

        function displayCredentials(arr) {
            document.getElementById("activate").classList.remove("disabled")
            out = "Username: " + arr.username + "<br>Password: " + arr.password + "<br>Valid until: " + arr.validity + "<br>";
            document.getElementById("status").className = "alert alert-success"
            document.getElementById("status").innerHTML = out;
        }
    }

    function activateSession() {
        document.getElementById("status").style.display = "block";
        var xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                console.log('response', this.responseText);
                if (this.responseText == "User not exists") {
                    document.getElementById("activate").classList.add("disabled")
                    document.getElementById("status").className = "alert alert-warning"
                    document.getElementById("status").innerHTML = "You have no credentials. Please generate new.";
                } else {
                    var myArr = JSON.parse(this.responseText);
                    displayOutput(myArr);
                }

            }
        };
        xmlhttp.open("GET", "/activate", true);
        xmlhttp.send();

        function displayOutput(arr) {
            document.getElementById("activate").classList.remove("disabled")
            out = "Session valid until: " + arr.validity;
            document.getElementById("status").className = "alert alert-success"
            document.getElementById("status").innerHTML = out;
        }
    }
</script>
</html>
